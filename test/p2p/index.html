
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>P2P 檔案分享 (WebRTC Demo)</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    textarea { width: 100%; height: 100px; margin-top: 5px; }
    button { margin: 5px 0; }
    .section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
    .copy-btn { margin-left: 5px; }

    /* 彈窗進度條 */
    #progressModal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    #progressBox {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      width: 300px;
    }
    #progressBar {
      width: 100%;
      height: 20px;
      background: #eee;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 10px;
    }
    #progressFill {
      width: 0;
      height: 100%;
      background: #4caf50;
    }
  </style>
</head>
<body>
  <h1>🔗 P2P 檔案分享 Demo</h1>

  <div class="section">
    <h2>👤 A：發送者</h2>
    <h3>Step 1. 建立 Offer</h3>
    <button id="createOffer">建立 Offer</button>
    <button class="copy-btn" onclick="copyText('offer')">複製 Offer</button>
    <textarea id="offer" placeholder="這裡會生成 Offer，複製給 B"></textarea>

    <h3>Step 3. 貼上 B 的 Answer</h3>
    <textarea id="answer" placeholder="把 B 給的 Answer 貼在這裡"></textarea>
    <button id="setAnswer">設定 Answer</button>

    <h3>📂 選擇要傳送的檔案</h3>
    <input type="file" id="fileInput">
  </div>

  <div class="section">
    <h2>👤 B：接收者</h2>
    <h3>Step 2. 貼上 A 的 Offer</h3>
    <textarea id="remoteOffer" placeholder="把 A 給的 Offer 貼在這裡"></textarea>
    <button id="createAnswer">生成 Answer</button>
    <button class="copy-btn" onclick="copyText('localAnswer')">複製 Answer</button>
    <textarea id="localAnswer" placeholder="生成的 Answer，複製給 A"></textarea>
  </div>

  <!-- 彈窗進度條 -->
  <div id="progressModal">
    <div id="progressBox">
      <h3>📥 檔案接收中...</h3>
      <div id="progressBar"><div id="progressFill"></div></div>
      <p id="progressText">0%</p>
    </div>
  </div>

  <script>
    let pc, channel, fileChunks = [], fileName = "download.bin", fileSize = 0, receivedSize = 0;

    function setupConnection() {
      pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      channel = pc.createDataChannel("file");
      pc.ondatachannel = e => {
        e.channel.onmessage = ev => {
          // 嘗試解析檔案資訊
          try {
            let info = JSON.parse(ev.data);
            if (info.name) {
              fileName = info.name;
              fileSize = info.size;
              receivedSize = 0;
              fileChunks = [];
              // 顯示進度條
              showProgress(0);
              return;
            }
          } catch (err) { /* 不是 JSON，忽略 */ }

          if (ev.data === "EOF") {
            const blob = new Blob(fileChunks);
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            a.click();
            fileChunks = [];
            hideProgress();
            alert(`📥 已接收檔案：${fileName}`);
          } else {
            fileChunks.push(ev.data);
            receivedSize += ev.data.byteLength || 0;
            if (fileSize > 0) {
              let percent = Math.floor((receivedSize / fileSize) * 100);
              showProgress(percent);
            }
          }
        };
      };
    }
    setupConnection();

    // 一鍵複製
    function copyText(id) {
      const el = document.getElementById(id);
      el.select();
      document.execCommand("copy");
      alert("已複製！");
    }

    // 顯示進度條
    function showProgress(percent) {
      document.getElementById("progressModal").style.display = "flex";
      document.getElementById("progressFill").style.width = percent + "%";
      document.getElementById("progressText").innerText = percent + "%";
    }
    function hideProgress() {
      document.getElementById("progressModal").style.display = "none";
    }

    // 建立 Offer (A)
    document.getElementById("createOffer").onclick = async () => {
      let offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      pc.onicecandidate = e => {
        if (!e.candidate) {
          document.getElementById("offer").value = JSON.stringify(pc.localDescription);
        }
      };
    };

    // 設定 Answer (A)
    document.getElementById("setAnswer").onclick = async () => {
      let answer = JSON.parse(document.getElementById("answer").value);
      await pc.setRemoteDescription(answer);
      alert("✅ 已連線成功，可以開始傳檔案！");
    };

    // 生成 Answer (B)
    document.getElementById("createAnswer").onclick = async () => {
      let offer = JSON.parse(document.getElementById("remoteOffer").value);
      await pc.setRemoteDescription(offer);
      let answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      pc.onicecandidate = e => {
        if (!e.candidate) {
          document.getElementById("localAnswer").value = JSON.stringify(pc.localDescription);
        }
      };
    };

    // 傳送檔案 (A)
    document.getElementById("fileInput").onchange = async e => {
      let file = e.target.files[0];
      let chunkSize = 16 * 1024;
      let offset = 0;

      // 傳送檔案資訊
      channel.send(JSON.stringify({ name: file.name, size: file.size }));

      let reader = new FileReader();
      reader.onload = async function(evt) {
        let buffer = evt.target.result;
        while (offset < buffer.byteLength) {
          let slice = buffer.slice(offset, offset + chunkSize);
          channel.send(slice);
          offset += chunkSize;
          await new Promise(r => setTimeout(r, 10));
        }
        channel.send("EOF");
        alert("📤 檔案傳送完成！");
      };
      reader.readAsArrayBuffer(file);
    };
  </script>
</body>
</html>
