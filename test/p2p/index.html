
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>P2P æª”æ¡ˆåˆ†äº« (WebRTC Demo)</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    textarea { width: 100%; height: 100px; }
    button { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>ğŸ”— P2P æª”æ¡ˆåˆ†äº« Demo</h1>
  
  <h3>Step 1: A å»ºç«‹ Offer</h3>
  <button id="createOffer">å»ºç«‹ Offer</button>
  <textarea id="offer" placeholder="é€™è£¡æœƒç”Ÿæˆ Offerï¼Œè¤‡è£½çµ¦å°æ–¹"></textarea>
  
  <h3>Step 2: B å›è¦† Answer</h3>
  <textarea id="answer" placeholder="æŠŠå°æ–¹çš„ Answer è²¼åˆ°é€™è£¡"></textarea>
  <button id="setAnswer">è¨­å®š Answer</button>

  <h3>ğŸ“‚ å‚³é€æª”æ¡ˆ</h3>
  <input type="file" id="fileInput">

  <script>
    var s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/eruda';
    document.body.appendChild(s);
    s.onload = function () { eruda.init(); };
    let pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }] // å…¬é–‹ STUN server
    });

    let channel = pc.createDataChannel("file");
    let fileChunks = [];

    // æ¥æ”¶æª”æ¡ˆ
    pc.ondatachannel = e => {
      e.channel.onmessage = ev => {
        if (ev.data === "EOF") {
          const blob = new Blob(fileChunks);
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "download.bin";
          a.click();
          fileChunks = [];
        } else {
          fileChunks.push(ev.data);
        }
      };
    };

    // å»ºç«‹ Offer
    document.getElementById("createOffer").onclick = async () => {
      let offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      // ç­‰å¾… ICE å®Œæ•´æ”¶é›†
      pc.onicecandidate = e => {
        if (!e.candidate) {
          document.getElementById("offer").value = JSON.stringify(pc.localDescription);
        }
      };
    };

    // è¨­å®š Answer
    document.getElementById("setAnswer").onclick = async () => {
      let answer = JSON.parse(document.getElementById("answer").value);
      await pc.setRemoteDescription(answer);
    };

    // å‚³é€æª”æ¡ˆ
    document.getElementById("fileInput").onchange = async e => {
      let file = e.target.files[0];
      let chunkSize = 16 * 1024; // 16KB
      let offset = 0;

      let reader = new FileReader();
      reader.onload = async function(evt) {
        let buffer = evt.target.result;
        while (offset < buffer.byteLength) {
          let slice = buffer.slice(offset, offset + chunkSize);
          channel.send(slice);
          offset += chunkSize;
          await new Promise(r => setTimeout(r, 10)); // é¿å…å¡çˆ†
        }
        channel.send("EOF");
        alert("æª”æ¡ˆå‚³é€å®Œæˆï¼");
      };
      reader.readAsArrayBuffer(file);
    };
  </script>
</body>
</html>
