
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>P2P æª”æ¡ˆåˆ†äº« (WebRTC Demo)</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    textarea { width: 100%; height: 100px; margin-top: 5px; }
    button { margin: 5px 0; }
    .section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
    .copy-btn { margin-left: 5px; }
  </style>
</head>
<body>
  <h1>ğŸ”— P2P æª”æ¡ˆåˆ†äº« Demo</h1>

  <div class="section">
    <h2>ğŸ‘¤ Aï¼šç™¼é€è€…</h2>
    <h3>Step 1. å»ºç«‹ Offer</h3>
    <button id="createOffer">å»ºç«‹ Offer</button>
    <button class="copy-btn" onclick="copyText('offer')">è¤‡è£½ Offer</button>
    <textarea id="offer" placeholder="é€™è£¡æœƒç”Ÿæˆ Offerï¼Œè¤‡è£½çµ¦ B"></textarea>

    <h3>Step 3. è²¼ä¸Š B çš„ Answer</h3>
    <textarea id="answer" placeholder="æŠŠ B çµ¦çš„ Answer è²¼åœ¨é€™è£¡"></textarea>
    <button id="setAnswer">è¨­å®š Answer</button>

    <h3>ğŸ“‚ é¸æ“‡è¦å‚³é€çš„æª”æ¡ˆ</h3>
    <input type="file" id="fileInput">
  </div>

  <div class="section">
    <h2>ğŸ‘¤ Bï¼šæ¥æ”¶è€…</h2>
    <h3>Step 2. è²¼ä¸Š A çš„ Offer</h3>
    <textarea id="remoteOffer" placeholder="æŠŠ A çµ¦çš„ Offer è²¼åœ¨é€™è£¡"></textarea>
    <button id="createAnswer">ç”Ÿæˆ Answer</button>
    <button class="copy-btn" onclick="copyText('localAnswer')">è¤‡è£½ Answer</button>
    <textarea id="localAnswer" placeholder="ç”Ÿæˆçš„ Answerï¼Œè¤‡è£½çµ¦ A"></textarea>
  </div>

  <script>
    let pc, channel, fileChunks = [];

    function setupConnection() {
      pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      channel = pc.createDataChannel("file");
      pc.ondatachannel = e => {
        e.channel.onmessage = ev => {
          if (ev.data === "EOF") {
            const blob = new Blob(fileChunks);
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "download.bin";
            a.click();
            fileChunks = [];
            alert("æª”æ¡ˆæ¥æ”¶å®Œæˆï¼");
          } else {
            fileChunks.push(ev.data);
          }
        };
      };
    }
    setupConnection();

    // ä¸€éµè¤‡è£½
    function copyText(id) {
      const el = document.getElementById(id);
      el.select();
      document.execCommand("copy");
      alert("å·²è¤‡è£½ï¼");
    }

    // å»ºç«‹ Offer (A)
    document.getElementById("createOffer").onclick = async () => {
      let offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      pc.onicecandidate = e => {
        if (!e.candidate) {
          document.getElementById("offer").value = JSON.stringify(pc.localDescription);
        }
      };
    };

    // è¨­å®š Answer (A)
    document.getElementById("setAnswer").onclick = async () => {
      let answer = JSON.parse(document.getElementById("answer").value);
      await pc.setRemoteDescription(answer);
      alert("âœ… å·²é€£ç·šæˆåŠŸï¼Œå¯ä»¥é–‹å§‹å‚³æª”æ¡ˆï¼");
    };

    // ç”Ÿæˆ Answer (B)
    document.getElementById("createAnswer").onclick = async () => {
      let offer = JSON.parse(document.getElementById("remoteOffer").value);
      await pc.setRemoteDescription(offer);
      let answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      pc.onicecandidate = e => {
        if (!e.candidate) {
          document.getElementById("localAnswer").value = JSON.stringify(pc.localDescription);
        }
      };
    };

    // å‚³é€æª”æ¡ˆ (A)
    document.getElementById("fileInput").onchange = async e => {
      let file = e.target.files[0];
      let chunkSize = 16 * 1024;
      let offset = 0;

      let reader = new FileReader();
      reader.onload = async function(evt) {
        let buffer = evt.target.result;
        while (offset < buffer.byteLength) {
          let slice = buffer.slice(offset, offset + chunkSize);
          channel.send(slice);
          offset += chunkSize;
          await new Promise(r => setTimeout(r, 10));
        }
        channel.send("EOF");
        alert("ğŸ“¤ æª”æ¡ˆå‚³é€å®Œæˆï¼");
      };
      reader.readAsArrayBuffer(file);
    };
  </script>
</body>
</html>
